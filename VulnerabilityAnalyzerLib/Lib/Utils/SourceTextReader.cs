using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Threading.Tasks;

namespace Lib.Models
{
    public class SourceTextReader
    {
        public List<SourceText> SourceTexts { get; } = new();
        public List<string> SourceExtensions { get; set; } = new() { "cpp", "c", "h", "hpp" };
        
        async public Task ReadFromFile(string filePath)
        {
            try
            {
                using (StreamReader sr = new StreamReader(filePath))
                {
                    List<SourceLine> lines = new List<SourceLine>();
                    while (!sr.EndOfStream) 
                    {
                        string line = await sr.ReadLineAsync();
                        for(int i = 0; i < line.Length; i++) {
                            lines.Add(new SourceLine() { Line = line,LineNumber = i ,SourcePath = filePath}) ;
                        }          
                    }
                    SourceTexts.Add(new SourceText(filePath,lines));
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine("Ошибка чтения файла: " + ex.Message);
            }
        }

        async public void ReadFromDir(string dirPath)
        {
            var files = Directory.GetFiles(dirPath);
            foreach (var file in files)
            {
                if (SourceExtensions.Contains(Path.GetExtension(file))) 
                {
                    await ReadFromFile(file);
                }
            }

            var subDirs = Directory.GetDirectories(dirPath);
            foreach (var subDir in subDirs)
            {
                ReadFromDir(subDir);
            }
        }

        public void Flush() => SourceTexts.Clear();
    }
}

