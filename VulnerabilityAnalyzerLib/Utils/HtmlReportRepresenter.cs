using System.Data;
using System.IO;
using System.Text;
using VulnerabilityAnalyzerLib.Models;

namespace VulnerabilityAnalyzerLib.Utils
{
    public class HtmlReportRepresenter : IReportRepresenter
    {
        public void Dump(Report report, string filePath)
        {
            File.WriteAllText(filePath, Dumps(report));
        }

        public string Dumps(Report report)
        {
            var builder = new StringBuilder();
            var dataTable = new DataTable();
            dataTable.Columns.Add("Vulnerabilities");
            dataTable.Columns.Add("File path, line number");
            dataTable.Columns.Add("Detected line");

            for (int i = 0; i < report.ReportNodes.Count; i++)
            {
                string rowValue = string.Format("{0} - {1} ", report.ReportNodes[i].SourceLine.SourcePath, report.ReportNodes[i].SourceLine.LineNumber);
                dataTable.Rows.Add(report.ReportNodes[i].Vulnerability.Name, rowValue, report.ReportNodes[i].SourceLine.Line);
            }

            builder.Append("<html>" +
                "﻿<style>" +
                "table, th, td " +
                "{ " +
                "border: 1px solid black;" +
                "  border-collapse: collapse;" +
                "}" +
                "</style>" +
                "<body>" +
                "<table>");

            builder.Append("<tr>");
            foreach (DataColumn c in dataTable.Columns)
            {
                builder.Append("<td>");
                builder.Append(c.ToString());
                builder.Append("</td>");
            }
            builder.Append("</tr>");
            foreach (DataRow r in dataTable.Rows)
            {
                builder.Append("<tr>");

                foreach (var o in r.ItemArray)
                {
                    builder.Append("<td>");
                    builder.Append(o.ToString());
                    builder.Append("</td>");
                }
                builder.Append("</tr>");
            }

            builder.Append("</table></body></html>");

            return builder.ToString();
        }
    }
}
