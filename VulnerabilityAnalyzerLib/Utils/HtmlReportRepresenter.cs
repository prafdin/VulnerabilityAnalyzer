using System.Collections.Generic;
using System.Data;
using System.IO;
using System.Text;

namespace Models
{
    public partial class Report
    {
        public class HtmlReportRepresenter : IReportRepresenter
        {
            public void Dump(string filePath, List<ReportNode> reportNodes)
            {
                File.WriteAllText(filePath, Dumps(reportNodes));
            }

            public string Dumps(List<ReportNode> reportNodes)
            {
                var builder = new StringBuilder();
                var dataTable = new DataTable();
                dataTable.Columns.Add("Vulnerabilities");
                dataTable.Columns.Add("File path, line number");
                dataTable.Columns.Add("Detected line");
                dataTable.Columns.Add("Detected patterns");

                for (int i = 0; i < reportNodes.Count; i++)
                {
                    string rowValue = string.Format("{0} - {1} ", reportNodes[i].SourceLine.SourcePath, reportNodes[i].SourceLine.LineNumber);
                    dataTable.Rows.Add(reportNodes[i].Vulnerability.Name, rowValue, reportNodes[i].PassedPatterns[0], reportNodes[i].Vulnerability.patterns[0]);//сделать цикл для патернов
                }

                builder.Append("<html>" +
                    "﻿<style>" +
                    "table, th, td " +
                    "{ " +
                    "border: 1px solid black;" +
                    "  border-collapse: collapse;" +
                    "}" +
                    "</style>" +
                    "<body>" +
                    "<table>");

                builder.Append("<tr>");
                foreach (DataColumn c in dataTable.Columns)
                {
                    builder.Append("<td>");
                    builder.Append(c.ToString());
                    builder.Append("</td>");
                }
                builder.Append("</tr>");
                foreach (DataRow r in dataTable.Rows)
                { 
                    builder.Append("<tr>");

                    foreach (var o in r.ItemArray)
                    {
                        builder.Append("<td>");
                        builder.Append(o.ToString());
                        builder.Append("</td>");
                    }
                    builder.Append("</tr>");
                }
                
                builder.Append("</table></body></html>");

                return builder.ToString();
            }
        }
    }
}
