using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Text.RegularExpressions;
using System.Threading.Tasks;

namespace VulnerabilityAnalyzerLib.Models.Vulnerabilities
{
    public class BufferOverflowVulnerability: Vulnerability
    {
        public BufferOverflowVulnerability()
        {
            Name = "Buffer overflow vulnerability";
            InitializePatterns();
        }

        private void InitializePatterns()
        {
            Patterns = new();
         
            Patterns.Add((src) =>
            {
                var dangerousRegexPatterns = new List<string>() {
                    @".*strcpy\(.*",
                    @".*strncpy\(.*",
                    @".*\sgets\(.*",
                    @".*strcat\(.*",
                    @".*\sscanf\(.*",
                };
                
                var lines = new List<SourceLine>();
                foreach(var line in src.Lines)
                {
                    foreach(var dangerousRegexPattern in dangerousRegexPatterns)
                    {
                        var regex = new Regex(dangerousRegexPattern, RegexOptions.IgnoreCase);
                        MatchCollection matches = regex.Matches(line.Line);
                        if (matches.Count > 0)
                        {
                            lines.Add(line);
                        }
                    }
                }
                return lines;
            });


        }
    }
}
