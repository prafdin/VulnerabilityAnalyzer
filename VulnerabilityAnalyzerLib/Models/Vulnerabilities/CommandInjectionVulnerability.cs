using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Text.RegularExpressions;
using System.Threading.Tasks;
using System.Xml.Linq;

namespace VulnerabilityAnalyzerLib.Models.Vulnerabilities
{
    public class CommandInjectionVulnerability :Vulnerability
    {

        public CommandInjectionVulnerability() {
            Name = "Command Injection vulnerability";
            InitializePatterns();
        }
        private void InitializePatterns()
        {
            Patterns = new();

            Patterns.Add((src) =>
            {

                var arrayChar = new List<string>();
                var danger = new[] { "system", "popen", "execlp", "execvp", "_wsystem" };
                var readingData = new[] { @"scanf\(", @"gets\(", "cin >>"};
                var vulnerabilities = new List<SourceLine>();
                var dangerousVariable = new List<string>();

                foreach (var line in src.Lines)
                {
                    var match = Regex.Match(line.Line, @"char\s+(\w+)\s*\[");
                    if (match.Success)
                    {
                        var newchar = match.Groups[1].Value;
                        arrayChar.Add(newchar);
                    }
                }

                foreach (var line in src.Lines)
                {
                    bool flag = true;
                    foreach (string elementOfArray in arrayChar)
                    {
                        for(int i =0; i< dangerousVariable.Count(); i++)
                        {
                            if (dangerousVariable[i] == elementOfArray)
                            {
                                flag = false;
                            }
                            else
                            {
                                flag = true;
                            }
                        }
                        if (flag)
                        {
                            foreach (var data in readingData)
                            {
                                if (Regex.IsMatch(line.Line, $@"{data}\s*{elementOfArray}"))
                                {
                                    dangerousVariable.Add(elementOfArray);
                                }
                            }
                        }
                    }
                } 

                foreach (var line in src.Lines)
                {
                    foreach(var variable in dangerousVariable)
                    {
                        foreach (var d in danger)
                        {
                            var regexPattern = $@"{d}\s*\({variable}[^)]*\)";
                            var match = Regex.Match(line.Line, regexPattern);
                            if (match.Success)
                            {
                                foreach (var ch in charmas)
                                {
                                    vulnerabilities.Add(line);
                                }
                            }
                        }
                    } 

                }
                return vulnerabilities;
            });
        }
    }
}


