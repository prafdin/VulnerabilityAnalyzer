using Stimulsoft.System.Windows.Forms;
using System.Collections.Generic;
using System.Linq;
using System.Text.RegularExpressions;

namespace VulnerabilityAnalyzerLib.Models.Vulnerabilities
{
    public class UnsafeErrorsHandlingVulnerability: Vulnerability
    {
        public UnsafeErrorsHandlingVulnerability()
        {
            Name = "Unsafe Errors Handling Vulnerability";
            InitializePatterns();
        }

        private void InitializePatterns()
        {
            Patterns = new();

            Patterns.Add((src) =>
            {
                var systemFunctions = new List<string>()
                {
                    @".*scanf\s*\(.*",
                    @".*scanf_s\s*\(.*",
                    @".*cin.*"
                };

                //Exceptions
                var linesWithException = new List<SourceLine>();
                foreach(var line in src.Lines)
                {
                    var pattern = @"\s*throw\s*";
                    var regex = new Regex(pattern);
                    Match match = regex.Match(line.Line);
                    if (match.Success)
                    {
                        linesWithException.Add(line);
                    }
                }

                foreach(var line in src.Lines)
                {
                    var pattern = @"\s*catch\s*\(";
                    var regex = new Regex(pattern);
                    Match match = regex.Match(line.Line);
                    if (match.Success)
                    {
                        linesWithException.Clear();
                    }
                }

                //Null pointer
                var linesWithSystemFunction = new List<SourceLine>();
                foreach(var line in src.Lines)
                {
                    foreach(var systemFunction in systemFunctions)
                    {
                        var regex = new Regex(systemFunction);
                        Match match = regex.Match(line.Line);
                        if (match.Success)
                        {
                            linesWithSystemFunction.Add(line);
                        }
                    }
                }

                var namesVariables = new List<string>();
                foreach (var line in src.Lines)
                {
                    var patternForVariable = @"\*\s*([a-zA-Z0-9])";
                    var regex = new Regex(patternForVariable);
                    Match match = regex.Match(line.Line);
                    if (match.Success)
                    {
                        namesVariables.Add(match.Groups[1].Value);
                    }
                }

                var linesWithPointer = new Dictionary<string, SourceLine>();
                foreach (var line in linesWithSystemFunction)
                {
                    foreach (var variable in namesVariables)
                    {
                        var pattern = $@".*\s*{variable}\s*=";
                        var regex = new Regex(pattern);
                        Match match = regex.Match(line.Line);
                        if (match.Success)
                        {
                            linesWithPointer.Add(variable, line);
                        }
                    }
                }

                foreach(var line in src.Lines)
                {
                    foreach(var lineWithPointer in linesWithPointer.Keys)
                    {
                        var pattern = $@"\s*if\s*\(\s*{lineWithPointer}.*(null)";
                        var regex = new Regex(pattern);
                        Match match = regex.Match(line.Line);
                        if (match.Success)
                        {
                            linesWithPointer.Remove(lineWithPointer);
                        }
                    }
                }

                var linesWithoutCheckNullPointer = new List<SourceLine>(linesWithPointer.Values);

                var lines = linesWithException.Concat(linesWithoutCheckNullPointer).ToList();

                return lines;
            });
        }
    }
}
