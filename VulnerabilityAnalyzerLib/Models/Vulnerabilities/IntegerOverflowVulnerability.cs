using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Text.RegularExpressions;
using System.Threading.Tasks;

namespace VulnerabilityAnalyzerLib.Models.Vulnerabilities
{
    public class IntegerOverflowVulnerability : Vulnerability
    {
        public IntegerOverflowVulnerability()
        {
            Name = "Integer Overflow Vulnerability";
            InitializePatterns();
        }

        private void InitializePatterns()
        {
            Patterns = new();

            Patterns.Add((src) =>
            {
                var varNames = new List<string>();
                foreach (var line in src.Lines)
                {
                    var pattern = @"\bint\s+(\w+)\s*[=|;]";
                    var regex = new Regex(pattern);
                    Match match = regex.Match(line.Line);
                    if (match.Success)
                    {
                        varNames.Add(match.Groups[1].Value);
                    }
                }

                var lines = new List<SourceLine>();
                foreach(var line in src.Lines)
                {
                    foreach(var varName in varNames)
                    {
                        var pattern = $@"\s*{varName}\s*=\s*[\w]+\s*[+*\/-]\s*[\w]+";
                        var regex = new Regex(pattern);
                        Match match = regex.Match(line.Line);
                        if (match.Success)
                        {
                            lines.Add(line);
                        }
                    }
                }

                return lines;
            });
        }
    }
}
