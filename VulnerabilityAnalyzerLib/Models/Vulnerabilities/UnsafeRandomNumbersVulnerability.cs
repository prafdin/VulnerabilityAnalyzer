using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Text.RegularExpressions;
using System.Threading.Tasks;

namespace VulnerabilityAnalyzerLib.Models.Vulnerabilities
{
    public class UnsafeRandomNumbersVulnerability : Vulnerability
    {
        public UnsafeRandomNumbersVulnerability()
        {
            Name = "Unsafe Random Numbers Vulnerability";
            InitializePatterns();
        }

        private void InitializePatterns()
        {
            Patterns = new();

            Patterns.Add((src) =>
            {
                //Exceptions
                var linesWithRand = new List<SourceLine>();
                foreach (var line in src.Lines)
                {
                    var pattern = @"\b(rand)\b\s*\(";
                    var regex = new Regex(pattern);
                    Match match = regex.Match(line.Line);
                    if (match.Success)
                    {
                        linesWithRand.Add(line);
                    }
                }

                var linesWithSrand = new List<SourceLine>();
                foreach (var line in src.Lines)
                {
                    var pattern = @"\b(srand)\b\s*\(";
                    var regex = new Regex(pattern);
                    Match match = regex.Match(line.Line);
                    if (match.Success)
                    {
                        linesWithSrand.Add(line);
                    }
                }

                foreach (var line in linesWithSrand)
                {
                    var pattern = @"\s*\(\s*time\s*\(";
                    var regex = new Regex(pattern);
                    Match match = regex.Match(line.Line);
                    if (match.Success)
                    {
                        linesWithRand.Clear();
                    }
                }

                return linesWithRand;
            });
        }
    }
}
