using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Text.RegularExpressions;
using System.Threading.Tasks;

namespace VulnerabilityAnalyzerLib.Models.Vulnerabilities
{
    public class UnsafeRandomNumbersVulnerability : Vulnerability
    {
        public UnsafeRandomNumbersVulnerability()
        {
            Name = "Unsafe Random Numbers Vulnerability";
            InitializePatterns();
        }

        private void InitializePatterns()
        {
            Patterns = new();

            Patterns.Add((src) => { return absenceRand(src); });
            Patterns.Add((src) => { return initializationNotRandomNumber(src); });
        }

        private List<SourceLine> absenceRand(SourceText src)
        {
            var linesWithRand = new List<SourceLine>();
            foreach (var line in src.Lines)
            {
                var pattern = @"\brand\s*\(";
                var regex = new Regex(pattern);
                Match match = regex.Match(line.Line);
                if (match.Success)
                {
                    linesWithRand.Add(line);
                }
            }

            var linesWithSrand = new List<SourceLine>();
            foreach (var line in src.Lines)
            {
                var pattern = @"\bsrand\s*\(";
                var regex = new Regex(pattern);
                Match match = regex.Match(line.Line);
                if (match.Success)
                {
                    linesWithSrand.Add(line);
                }
            }

            if(linesWithSrand.Count != 0)
            {
                linesWithRand.Clear();
            }

            return linesWithRand;
        }

        private List<SourceLine> initializationNotRandomNumber(SourceText src)
        {
            var linesWithSrand = new List<SourceLine>();
            foreach (var line in src.Lines)
            {
                var pattern = @"\bsrand\s*\(";
                var regex = new Regex(pattern);
                Match match = regex.Match(line.Line);
                if (match.Success)
                {
                    linesWithSrand.Add(line);
                }
            }

            var lines = new List<SourceLine>(linesWithSrand);
            foreach (var line in linesWithSrand)
            {
                var pattern = @"\s*\(\s*time\s*\(";
                var regex = new Regex(pattern);
                Match match = regex.Match(line.Line);
                if (match.Success)
                {
                    lines.Remove(line);
                }
            }

            return lines;
        }
    }
}
