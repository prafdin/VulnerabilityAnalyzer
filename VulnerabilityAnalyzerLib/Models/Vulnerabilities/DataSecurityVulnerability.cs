using Stimulsoft.Report;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Text.RegularExpressions;
using System.Threading.Tasks;

namespace VulnerabilityAnalyzerLib.Models.Vulnerabilities
{
    public class DataSecurityVulnerability : Vulnerability
    {
        public DataSecurityVulnerability()
        {
            Name = "Data Security vulnerability";
            InitializePatterns();
        }

        private void InitializePatterns()
        {

            Patterns = new();

            Patterns.Add((src) =>
            {
                var vulnerabilities = new List<SourceLine>();
                var foundStrings = new List<SourceLine>();
                var type = new[] { "char", "string"};
                var dangerWords = new[] { "password", "username", "pass", "user", "pas", "token", "tkn", "pswrd", "key" };

                foreach (var line in src.Lines)
                { 
                    foreach (var t in type)
                    {
                        var match = Regex.Match(line.Line, $@"{t}\s+(\w+)\s*");
                        if (match.Success)
                        {
                            var newchar = match.Groups[1].Value;
                            foundStrings.Add(line);
                        }
                    }
                }
                foreach (var strings in foundStrings)
                {
                    foreach (var word in dangerWords)
                    {
                        if (Regex.IsMatch(strings.Line, $@"\b{word}\b")) 
                        {
                            vulnerabilities.Add(strings);
                        }
                            
                    }
                }
                return vulnerabilities;
            });
        }
    
    }

}
