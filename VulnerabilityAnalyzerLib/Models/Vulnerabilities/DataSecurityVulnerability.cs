using System.Collections.Generic;
using System.Text.RegularExpressions;

namespace VulnerabilityAnalyzerLib.Models.Vulnerabilities
{
    public class DataSecurityVulnerability : Vulnerability
    {
        public DataSecurityVulnerability()
        {
            Name = "Data Security vulnerability";
            InitializePatterns();
        }

        private void InitializePatterns()
        {

            Patterns = new();

            Patterns.Add((src) =>
            {
                var vulnerabilities = new List<SourceLine>();
                var foundStrings = new List<SourceLine>();
                var typeOfVariable = new[] { "char", "string" };
                var dangerWords = new[] { "password", "username", "pass", "user", "pas", "token", "tkn", "pswrd", "key" };

                foreach (var line in src.Lines)
                {
                    foreach (var variable in typeOfVariable)
                    {
                        var match = Regex.Match(line.Line, $@"{variable}\s+(\w+)\s*");
                        if (match.Success)
                        {
                            var newchar = match.Groups[1].Value;
                            foundStrings.Add(line);
                        }
                    }
                }
                foreach (var strings in foundStrings)
                {
                    foreach (var word in dangerWords)
                    {
                        if (Regex.IsMatch(strings.Line, $@"\b{word}\b"))
                        {
                            vulnerabilities.Add(strings);
                        }

                    }
                }
                return vulnerabilities;
            });
        }

    }

}
