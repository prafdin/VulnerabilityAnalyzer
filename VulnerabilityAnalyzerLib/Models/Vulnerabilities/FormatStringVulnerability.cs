using System.Collections.Generic;
using System.Text.RegularExpressions;

namespace VulnerabilityAnalyzerLib.Models.Vulnerabilities
{
    public class FormatStringVulnerability : Vulnerability
    {
        public FormatStringVulnerability()
        {
            Name = "Format String Vulnerability";
            InitializePatterns();
        }

        private void InitializePatterns()
        {
            Patterns = new();

            Patterns.Add((src) =>
            {
                var functionsScan = new List<string>()
                {
                    @".*scanf\(.*",
                    @".*scanf_s\(.*",
                    @".*scanf \(.*",
                    @".*scanf_s \(.*",
                    @".*cin.*"
                };

                var patternsForVariable = new List<string>()
                {
                    "\",.*([0-9a-zA-Z])",
                    @">>.*([0-9a-zA-Z])"
                };

                var functionsPrint = new List<string>()
                {
                    @".*printf\(.*",
                    @".*printf \(.*"
                };

                var parameters = new List<string>()
                {
                    @".*%%.*",
                    @".*%p.*",
                    @".*%d.*",
                    @".*%c.*",
                    @".*%u.*",
                    @".*%x.*",
                    @".*%s.*",
                    @".*%n.*"
                };

                var namesVariables = new List<string>();
                foreach (var line in src.Lines)
                {
                    foreach (var func in functionsScan)
                    {
                        var regexFunc = new Regex(func);
                        MatchCollection matchesFunc = regexFunc.Matches(line.Line);
                        if (matchesFunc.Count > 0)
                        {
                            foreach (var pattern in patternsForVariable)
                            {
                                var regexPattern = new Regex(pattern);
                                Match matchesPattern = regexPattern.Match(line.Line);
                                var varName = regexPattern.Matches(line.Line);
                                if (matchesPattern.Success)
                                {
                                    namesVariables.Add(matchesPattern.Groups[1].Value);
                                }
                            }
                        }
                    }
                }

                var linesWithPrintFunctions = new List<SourceLine>();
                foreach (var line in src.Lines)
                {
                    foreach (var func in functionsPrint)
                    {
                        var regexFunc = new Regex(func);
                        MatchCollection matchesFunc = regexFunc.Matches(line.Line);
                        if (matchesFunc.Count > 0)
                        {
                            var count = 0;
                            foreach (var param in parameters)
                            {
                                var regexParam = new Regex(param);
                                MatchCollection matchesParam = regexParam.Matches(line.Line);
                                if (matchesParam.Count > 0)
                                {
                                    count++;
                                }
                            }
                            if (count == 0)
                            {
                                linesWithPrintFunctions.Add(line);
                            }
                        }
                    }
                }

                var lines = new List<SourceLine>();
                foreach (var line in linesWithPrintFunctions)
                {
                    foreach (var variable in namesVariables)
                    {
                        var str = ".*" + variable + ".*";
                        var regex = new Regex(str);
                        MatchCollection matches = regex.Matches(line.Line);
                        if (matches.Count > 0)
                        {
                            lines.Add(line);
                        }
                    }
                }
                return lines;
            });
        }
    }
}
