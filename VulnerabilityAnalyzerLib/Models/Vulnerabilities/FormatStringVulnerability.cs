using System.Collections.Generic;
using System.Text.RegularExpressions;

namespace VulnerabilityAnalyzerLib.Models.Vulnerabilities
{
    public class FormatStringVulnerability : Vulnerability
    {
        public FormatStringVulnerability()
        {
            Name = "Format String Vulnerability";
            InitializePatterns();
        }

        private void InitializePatterns()
        {
            Patterns = new();

            Patterns.Add((src) =>
            {
                var scanFunctions = new List<string>()
                {
                    @".*scanf\s*\(.*",
                    @".*scanf_s\s*\(.*",
                    @".*cin.*"
                };

                var patternsForVariable = new List<string>()
                {
                    "\",\\s*&([0-9a-zA-Z])",
                    ">>\\s*([0-9a-zA-Z])"
                };

                var linesWithScanFunction = new List<SourceLine>();
                foreach (var line in src.Lines)
                {
                    foreach (var scanFunction in scanFunctions)
                    {
                        var regex = new Regex(scanFunction);
                        Match match = regex.Match(line.Line);
                        if (match.Success)
                        {
                            linesWithScanFunction.Add(line);
                        }
                    }
                }

                var nameVariables = new List<string>();
                foreach (var line in linesWithScanFunction)
                {
                    foreach (var pattern in patternsForVariable)
                    {
                        var regex = new Regex(pattern);
                        Match match = regex.Match(line.Line);
                        if (match.Success)
                        {
                            nameVariables.Add(match.Groups[1].Value);
                            break;
                        }
                    }
                }

                var linesWithPrintFunctions = new List<SourceLine>();
                foreach (var line in src.Lines)
                {
                    var patternPrintFunction = @".*printf\s*\(.*";
                    var regex = new Regex(patternPrintFunction);
                    Match match = regex.Match(line.Line);
                    if (match.Success)
                    {
                        linesWithPrintFunctions.Add(line);
                    }
                }

                var linesWithPrintWithoutParameters = new List<SourceLine>();
                foreach (var line in linesWithPrintFunctions)
                {
                    var patternForParameter = ".*(%\\w|%%).*";
                    var regex = new Regex(patternForParameter);
                    Match match = regex.Match(line.Line);
                    if (!match.Success)
                    {
                        linesWithPrintWithoutParameters.Add(line);
                    }
                }

                var lines = new List<SourceLine>();
                foreach (var line in linesWithPrintWithoutParameters)
                {
                    foreach (var variable in nameVariables)
                    {
                        var str = "\\(.*" + variable + ".*\\)";
                        var regex = new Regex(str);
                        Match match = regex.Match(line.Line);
                        if (match.Success)
                        {
                            lines.Add(line);
                        }
                    }
                }
                return lines;
            });
        }
    }
}
