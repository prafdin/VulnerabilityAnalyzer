using Stimulsoft.Report;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Text.RegularExpressions;
using System.Threading.Tasks;

namespace VulnerabilityAnalyzerLib.Models.Vulnerabilities
{
    public class SQLInjectionVulnerability : Vulnerability
    {
        public SQLInjectionVulnerability() {

            Name = "SQL injection vulnerability";
            InitializePatterns();
        }

        private void InitializePatterns()
        {
            Patterns = new();

            Patterns.Add((src) =>
            {
                var dangerousVariables = new HashSet<string>();
                var vulnerabilities = new List<SourceLine>();
                var typeOfVariable = new[] { "char", "string" };
                var variables = new List<string>();
                var readingData = new[] { @"scanf\(", @"gets\(", "cin >>" };
                var dangerousVariable = new List<string>();

                foreach (var line in src.Lines)
                {
                    foreach (var type in typeOfVariable)
                    {
                        var match = Regex.Match(line.Line, $@"{type}\s+(\w+)\s*");
                        if (match.Success)
                        {
                            variables.Add(match.Groups[1].Value);
                        }
                    }

                }

                foreach (var line in src.Lines)
                {
                    foreach (string variable in variables)
                    {
                        foreach (var data in readingData)
                        {
                            if (Regex.IsMatch(line.Line, $@"{data}\s*{variable}"))
                            {
                                dangerousVariable.Add(variable);
                            }
                        }
                    }
                }

                foreach (var line in src.Lines)
                {
                    foreach (var variable in dangerousVariable)
                    {
                            var regexPattern = $@"exec(.*{variable})";
                            if (Regex.IsMatch(line.Line, regexPattern))
                            {
                                vulnerabilities.Add(line);
                            }
                    }

                }

                return vulnerabilities;
            });

        }

    }      
}
