using Common.Models;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Text.Json;
using System.Threading.Tasks;


namespace VulnerabilityAnalyzerLib.Repository
{
    public class JsonVulnerabilityRepository : IVulnerabilityRepository
    {
        private string _filePath;
        private List<Vulnerability> _vulnerabilities;

        public JsonVulnerabilityRepository(string filePath)
        {
            this._filePath = filePath;
        }

        public int AddVulnerability(Vulnerability vulnerability) =>
            AddVulnerabilityAsync(vulnerability).Result;

        public IEnumerable<Vulnerability> GetAllVulnerabilities() =>
            GetAllVulnerabilitiesAsync().Result;

        public int UpdateVulnerability(Vulnerability changedVulnerability) =>
            UpdateVulnerabilityAsync(changedVulnerability).Result;

        public bool DeleteVulnerability(Vulnerability vulnerability) =>
            DeleteVulnerabilityAsync(vulnerability).Result;

        public async Task<int> AddVulnerabilityAsync(Vulnerability vulnerability)
        {
            await ReadFromFile();
            _vulnerabilities?.Add(vulnerability);
            await WriteToFile();
            return vulnerability.Id;
        }

        public async Task<bool> DeleteVulnerabilityAsync(Vulnerability vulnerability)
        {
            await ReadFromFile();
            Vulnerability toDelete = _vulnerabilities.FirstOrDefault(v => v.Id == vulnerability.Id);
            if (toDelete != null)
            {
                _vulnerabilities?.Remove(toDelete);
                await WriteToFile();
                return true;
            }
            return false;

        }

        public async Task<List<Vulnerability>> GetAllVulnerabilitiesAsync()
        {
            await ReadFromFile();
            return _vulnerabilities.ToList();
        }

        public async Task<int> UpdateVulnerabilityAsync(Vulnerability changedVulnerability)
        {
            await ReadFromFile();

            var foundVulnerability = _vulnerabilities.FirstOrDefault(v => v.Id == changedVulnerability.Id);
            if (foundVulnerability != null)
            {
                foundVulnerability.Name = changedVulnerability.Name;
                foundVulnerability.Patterns = changedVulnerability.Patterns;
                await WriteToFile();
            }

            return changedVulnerability.Id;
        }

        private async Task ReadFromFile()
        {
            if (!File.Exists(_filePath))
            {
                _vulnerabilities = new();
                return;
            }
            else
            {
                var jsonString = await File.ReadAllTextAsync(_filePath);
                _vulnerabilities = JsonSerializer.Deserialize<List<Vulnerability>>(jsonString);
            }

        }

        public async Task WriteToFile()
        {
            var jsonString = JsonSerializer.Serialize(_vulnerabilities);
            await File.WriteAllTextAsync(jsonString, _filePath);
        }

    }
}
