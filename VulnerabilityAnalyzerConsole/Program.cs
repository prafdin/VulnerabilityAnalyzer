using CommandLine;
using System.Collections.Generic;
using System;
using VulnerabilityAnalyzerConsole;
using VulnerabilityAnalyzerLib.Repository;
using System.IO;
using Common.Models;
using System.Text.Json;

public class Program
{
    static void Main(string[] args)
    {
        Parser.Default.ParseArguments<Options>(args)
               .WithParsed<Options>(async o =>
               {
                   string sourcePath = o.SourcePath;
                   string outputDirectory = o.OutputDirectory;
                   string rulesPath = o.RulesPath;

                   var vulnerabilityRepository = new JsonVulnerabilityRepository(o.RulesPath);
                   if (o.ImportPath != null)
                   {
                       try
                       {
                           var jsonString = await File.ReadAllTextAsync(o.ImportPath); 
                           var vulnerabilitiesToImport = JsonSerializer.Deserialize<List<Vulnerability>>(jsonString);

                           foreach (var vulnerability in vulnerabilitiesToImport)
                           {
                               vulnerabilityRepository.AddVulnerability(vulnerability);
                           }
                           Console.WriteLine($"Уязвимости были успешно импортированы из {o.ImportPath}.");
                       }
                       catch (Exception ex)
                       {
                           Console.WriteLine($"Ошибка при импорте уязвимостей: {ex.Message}");
                       }
                   }
               });
    }
}
