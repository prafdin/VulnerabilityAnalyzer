using System.Linq;
using VulnerabilityAnalyzerLib.Models.Vulnerabilities;
using VulnerabilityAnalyzerLib.Utils;
using Xunit;

namespace VulnerabilityAnalyzerLib.Tests.Models.Vulnerabilities
{
    public class DataSecurityVulnerabilityTests
    {
        static string ResourceRootDir = "./Resources/DataSecuritySamples";
        SourceTextReader SourceTextReader { get; }
        DataSecurityVulnerability Vulnerability { get; }

        public DataSecurityVulnerabilityTests()
        {
            SourceTextReader = new SourceTextReader();
            Vulnerability = new DataSecurityVulnerability();
        }

        [Fact]
        public async void FindPlainTextCredentials_PasswordFound_ReturnsVulnerability()
        {
            var fileName = "01.cpp";
            var filePath = $"{ResourceRootDir}/{fileName}";
            await SourceTextReader.ReadFromFile(filePath);
            var sourceText = SourceTextReader.SourceTexts.First(s => s.FilePath == filePath);
            var vulnerabilities = Vulnerability.ApplyPatterns(sourceText);

            Assert.Equal(2, vulnerabilities.Count);

        }

        [Fact]
        public async void FindPlainTextCredentials_NoVulnerability_ReturnsEmptyList()
        {
            var fileName = "02.cpp";
            var filePath = $"{ResourceRootDir}/{fileName}";
            await SourceTextReader.ReadFromFile(filePath);
            var sourceText = SourceTextReader.SourceTexts.First(s => s.FilePath == filePath);
            var vulnerabilities = Vulnerability.ApplyPatterns(sourceText);

            Assert.Empty(vulnerabilities);
        }

    }
}
