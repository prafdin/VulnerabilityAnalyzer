using Common.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using VulnerabilityAnalyzerLib.Models;
using Xunit;
using static VulnerabilityAnalyzerLib.Models.Report;

namespace VulnerabilityAnalyzerLib.Tests.Models
{
    public class ReportTests
    {
        [Fact]
        public async void Dumps_AssertNonEmptyReport()
        {
            var vulnerabilities = new List<Vulnerability>()
            {
                new Vulnerability() 
                {
                    Name = "Буффер", 
                    Patterns =  new List<Pattern>()
                    { 
                        new Pattern() { Mask = "hello world" } 
                    }
                } 
            };

            var sources = new List<SourceText>()
            {
                new SourceText(
                    "main.cpp", 
                    new List<SourceLine>
                    {
                        new SourceLine()
                        {
                            Line = "hello world",
                            LineNumber = 0,
                            SourcePath = "main.cpp"
                        }
                    }
                )
            };

            var representer = new HtmlReportRepresenter();


            var report = await Report.CreateReport(
                vulnerabilities,
                sources,
                representer
            );
            var expectedReport = "<html>﻿<style>table,th, td { border: 1px solid black;  border-collapse: collapse;}</style><body><table><tr><td>Vulnerabilities</td><td>File path, line number</td><td>Detected line</td><td>Detected patterns</td></tr><tr><td>Буффер</td><td>main.cpp - 0 </td><td>Common.Models.Pattern</td><td>Common.Models.Pattern</td></tr></table></body></html>";


            var result = report.Dumps();

            Assert.Equal(expectedReport, result);
        }

    }
}
