using DynamicData;
using ReactiveUI;
using ReactiveUI.Fody.Helpers;
using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Linq;
using System.Reactive;
using System.Threading.Tasks;
using VulnerabilityAnalyzerLib.Models;
using VulnerabilityAnalyzerLib.Utils;

namespace VulnerabilityAnalyzerGUI.ViewModels
{
    public class MainWindowViewModel : ReactiveObject
    {
        [Reactive]
        public ObservableCollection<SourceText> Sources { get; internal set; } = new();
        public List<Vulnerability> AllVulnerabilities { get; } = new();

        public ReactiveCommand<SourceText, Unit> CopySourceFullPathCommand { get; }
        public ReactiveCommand<SourceText, Unit> DeleteSourceTextCommand { get; }
        public ReactiveCommand<Unit, Unit> AddSourcesCommand { get; }
        public ReactiveCommand<Unit, Unit> CreateReportCommand { get; }

        public MainWindowViewModel()
        {
            InitVulnerabilities();

            CopySourceFullPathCommand = ReactiveCommand.CreateFromTask<SourceText, Unit>(CopySourceFullPathImpl);
            DeleteSourceTextCommand = ReactiveCommand.CreateFromTask<SourceText, Unit>(async (arg) =>
            {
                Sources.Remove(arg);
                return Unit.Default;
            });
            AddSourcesCommand = ReactiveCommand.CreateFromTask<Unit, Unit>(AddSourcesImpl);
            CreateReportCommand = ReactiveCommand.CreateFromTask<Unit, Unit>(CreateReportImpl);
        }

        private async Task<Unit> CreateReportImpl(Unit arg)
        {
            using (var dialog = new System.Windows.Forms.SaveFileDialog())
            {
                dialog.Title = "Save a report file";
                dialog.Filter = "HTML file|*.html";
                dialog.ShowDialog();
                if (dialog.FileName != "" && Sources.Count != 0 && AllVulnerabilities.Count != 0)
                {
                    var report = await Report.CreateReport(AllVulnerabilities, Sources.ToList());
                    new HtmlReportRepresenter().Dump(report, dialog.FileName);
                }
            }

            return Unit.Default;
        }

        private async Task<Unit> AddSourcesImpl(Unit arg)
        {
            using (var dialog = new System.Windows.Forms.OpenFileDialog())
            {
                dialog.Multiselect = true;
                System.Windows.Forms.DialogResult result = dialog.ShowDialog();
                var fileNames = dialog.FileNames;

                var sourceTextReader = new SourceTextReader();
                foreach (var fileName in fileNames)
                {
                    await sourceTextReader.ReadFromFile(fileName);
                }
                Sources.AddRange(sourceTextReader.SourceTexts);
            }
            return Unit.Default;
        }

        private async Task<Unit> CopySourceFullPathImpl(SourceText arg)
        {
            System.Windows.Clipboard.SetText(arg.FilePath);
            return Unit.Default;
        }

        private void InitVulnerabilities()
        {
            var vulnerabilityFactory = new VulnerabilityFactory();
            foreach (VulnerabilityType vulnerabilityType in Enum.GetValues(typeof(VulnerabilityType)))
            {
                AllVulnerabilities.Add(vulnerabilityFactory.GetVulnerability(vulnerabilityType));
            }
        }
    }
}
